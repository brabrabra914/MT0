<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå</title>
    <style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#2c1810;--accent:#8b4513;--gold:#d4af37;--cream:#f5f0e8;--forest:#2d5016;--burgundy:#722f37;--preparing:#1e5f74}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:linear-gradient(135deg,#1a0f0a 0%,#2c1810 50%,#1a1a2e 100%);min-height:100vh;color:var(--cream);padding:2rem 2.5rem;line-height:1.5}
.container{max-width:960px;margin:0 auto}
header{text-align:center;margin-bottom:2.5rem;padding:1.5rem}
header h1{font-size:2rem;font-weight:700;color:var(--gold);text-shadow:0 0 20px rgba(212,175,55,0.3)}
.subtitle{color:rgba(245,240,232,0.7);font-size:1rem;margin-top:0.25rem}
section{background:rgba(44,24,16,0.5);border:1px solid rgba(212,175,55,0.18);border-radius:14px;padding:1.75rem;margin-bottom:1.75rem;box-shadow:0 4px 24px rgba(0,0,0,0.25)}
section h2{font-size:1.3rem;font-weight:600;color:var(--gold);margin-bottom:1.1rem;padding-bottom:0.6rem;border-bottom:1px solid rgba(212,175,55,0.25);letter-spacing:0.02em}
.form-group{margin-bottom:1rem}
.form-group label{display:block;margin-bottom:0.4rem;font-size:0.9rem;color:rgba(245,240,232,0.9)}
.form-group select,.form-group input{width:100%;padding:0.6rem 0.8rem;border:1px solid rgba(212,175,55,0.3);border-radius:8px;background:rgba(26,15,10,0.8);color:var(--cream);font-family:inherit;font-size:1rem}
.form-group select:focus,.form-group input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(212,175,55,0.2)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.time-input-group,.date-input-group{display:flex;align-items:center;gap:0.5rem}
.date-input-group select,.time-input-group select{flex:1;padding:0.6rem 0.8rem;border:1px solid rgba(212,175,55,0.3);border-radius:8px;background:rgba(26,15,10,0.8);color:var(--cream);font-family:inherit;font-size:1rem}
.time-separator{color:var(--gold);font-weight:600}
.all-registered-msg{color:var(--gold);margin-top:0.5rem;font-size:0.9rem}
.btn-primary{width:100%;padding:0.8rem 1.5rem;background:linear-gradient(135deg,var(--gold),var(--accent));border:none;border-radius:8px;color:var(--primary);font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer;margin-top:0.5rem;transition:transform 0.2s,box-shadow 0.2s}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(212,175,55,0.4)}
.btn-primary:active{transform:translateY(0)}
.registered-list,.remaining-list{min-height:60px}
.empty-message{color:rgba(245,240,232,0.55);font-style:italic;padding:1.5rem 1rem;text-align:center;font-size:0.95rem}
.calendar-wrapper{overflow-x:auto;border-radius:10px}
.calendar-wrapper:not(.has-data) .calendar-table{display:none}
.calendar-wrapper.has-data .empty-message{display:none}
.calendar-table{width:100%;border-collapse:collapse;font-size:0.9rem;table-layout:fixed}
.calendar-table th,.calendar-table td{border:1px solid rgba(212,175,55,0.2);padding:0.75rem;text-align:left;vertical-align:top;width:1%;background:rgba(26,15,10,0.3)}
.calendar-table th{background:rgba(212,175,55,0.12);color:var(--gold);font-weight:600;min-width:130px;text-align:center;font-size:0.9rem;letter-spacing:0.02em}
.calendar-table td{min-width:130px;height:220px}
.calendar-table .course-cell{display:flex;flex-direction:column;gap:0.35rem;background:rgba(30,95,116,0.35);color:var(--cream);font-weight:500;border-radius:8px;padding:0.5rem 0.6rem;font-size:0.85rem;margin-bottom:0.5rem;border-left:4px solid var(--preparing);overflow:hidden;min-width:0;min-height:96px;height:96px;box-sizing:border-box;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.calendar-table .course-cell.preparing{background:rgba(45,80,22,0.35);border-left-color:var(--forest)}
.calendar-table .course-cell.preparing .course-time{color:var(--gold)}
.calendar-table .course-cell.completed{background:rgba(212,175,55,0.2);border-left-color:var(--gold)}
.calendar-table .course-cell.completed .course-name{color:rgba(245,240,232,0.98);text-decoration:underline}
.calendar-table .course-cell.completed .course-time{color:var(--gold)}
.calendar-table .course-cell.special{background:rgba(114,47,55,0.35);border-left-color:var(--burgundy)}
.calendar-table .course-cell.special .course-time{color:rgba(245,240,232,0.9)}
.calendar-table .course-cell:last-child{margin-bottom:0}
.calendar-table .course-cell .course-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;line-height:1.4;font-size:0.88em}
.calendar-table .course-cell .course-time{font-size:0.78rem;color:var(--gold);opacity:0.95}
.calendar-table .course-cell .cell-buttons{display:flex;flex-wrap:nowrap;gap:0.35rem;margin-top:auto;align-items:center;max-width:100%;flex-shrink:0;padding-top:0.25rem;border-top:1px solid rgba(255,255,255,0.08);justify-content:space-between}
.calendar-table .course-cell .cell-buttons .remove-btn{margin-left:auto}
.calendar-table .course-cell .cell-buttons .done-btn,.calendar-table .course-cell .cell-buttons .remove-btn{white-space:nowrap;flex-shrink:0;padding:0.3rem 0.5rem;border-radius:6px;font-size:0.7rem;cursor:pointer;font-family:inherit;transition:opacity 0.2s}
.calendar-table .course-cell .cell-buttons .done-btn:hover,.calendar-table .course-cell .cell-buttons .remove-btn:hover{opacity:0.9}
.calendar-table .course-cell .done-btn{background:rgba(30,95,116,0.7);border:none;color:#93c5fd}
.calendar-table .course-cell .done-btn:hover{background:var(--preparing)}
.calendar-table .course-cell.preparing .done-btn{background:rgba(45,80,22,0.7);color:var(--cream)}
.calendar-table .course-cell.preparing .done-btn:hover{background:var(--forest)}
.calendar-table .course-cell.completed .done-btn{background:rgba(212,175,55,0.5);color:var(--gold)}
.calendar-table .course-cell.completed .done-btn:hover{background:rgba(212,175,55,0.7)}
.calendar-table .course-cell .remove-btn{background:rgba(114,47,55,0.6);border:none;color:var(--cream);font-size:1.15em;line-height:1}
.calendar-table .course-cell .remove-btn:hover{background:var(--burgundy)}
.sidebar-magic{position:fixed;left:0;top:0;width:220px;height:100vh;background:rgba(26,15,10,0.97);border-right:1px solid rgba(212,175,55,0.25);padding:1.25rem;overflow-y:auto;z-index:100}
.sidebar-magic h3{font-size:1rem;color:var(--gold);margin-bottom:1rem;padding-bottom:0.6rem;border-bottom:1px solid rgba(212,175,55,0.3);letter-spacing:0.02em}
.sidebar-magic-list{list-style:none}
.sidebar-magic-year{margin-bottom:1.25rem}
.sidebar-magic-year h4{font-size:0.82rem;color:var(--gold);margin-bottom:0.5rem;opacity:0.95;letter-spacing:0.02em}
.sidebar-magic-list li{padding:0.5rem 0.7rem;margin-bottom:0.4rem;border-radius:8px;font-size:0.88rem;cursor:pointer;transition:all 0.2s;line-height:1.3}
.sidebar-magic-list li:hover{opacity:0.9}
.sidebar-magic-list li.learned{background:rgba(45,80,22,0.4);color:#4ade80;border-left:3px solid var(--forest)}
.sidebar-magic-list li.not-learned{background:rgba(114,47,55,0.3);color:#f87171;border-left:3px solid var(--burgundy)}
.main-with-sidebar{margin-left:220px;min-height:100vh}
.calendar-table .empty-cell{color:rgba(245,240,232,0.25);font-size:0.85rem;text-align:center;padding:1rem}
.stats-bar{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1.25rem;padding:0.9rem 1.2rem;background:rgba(0,0,0,0.25);border-radius:10px;border:1px solid rgba(212,175,55,0.15)}
.stats-bar span{color:rgba(245,240,232,0.9);font-size:0.9rem}
.stats-bar .stat-completed{color:var(--gold)}
.btn-clear-cal{padding:0.5rem 1rem;background:rgba(114,47,55,0.5);border:1px solid rgba(212,175,55,0.25);border-radius:8px;color:var(--cream);font-size:0.88rem;cursor:pointer;font-family:inherit;margin-left:auto;transition:all 0.2s}
.btn-clear-cal:hover{background:rgba(114,47,55,0.75)}
.stats-bar{display:flex;align-items:center;flex-wrap:wrap}
.calendar-table th.today{background:rgba(212,175,55,0.25);box-shadow:inset 0 0 0 2px var(--gold)}
.remaining-item{padding:0.7rem 1.1rem;background:rgba(139,69,19,0.18);border-radius:10px;margin-bottom:0.5rem;color:rgba(245,240,232,0.9);border-left:4px solid var(--accent);transition:all 0.2s;line-height:1.4}
.remaining-item:not(.registered){cursor:pointer}
.remaining-item:not(.registered):hover{background:rgba(139,69,19,0.35)}
.remaining-item.registered{opacity:0.5;text-decoration:line-through;cursor:default}
.remaining-hint{font-size:0.85rem;color:rgba(245,240,232,0.6);margin-bottom:0.5rem}
.toast-container{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column;gap:0.5rem;pointer-events:none}
.toast{padding:0.75rem 1.25rem;border-radius:8px;background:rgba(44,24,16,0.95);border:1px solid rgba(212,175,55,0.3);color:var(--cream);font-size:0.9rem;box-shadow:0 4px 20px rgba(0,0,0,0.4);animation:toastIn 0.3s ease;transition:opacity 0.3s ease,transform 0.3s ease}
.toast.success{border-left:4px solid var(--forest)}
.toast.error{border-left:4px solid var(--burgundy)}
.toast.info{border-left:4px solid var(--gold)}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@media(prefers-reduced-motion:reduce){.toast{animation:none;transition:none}.btn-primary:hover{transform:none}*{scroll-behavior:auto!important}}
@media print{.registration-section,.remaining-section,.toast-container,.stats-bar,.sidebar-magic{display:none!important}.main-with-sidebar{margin-left:0!important}body{background:#fff;color:#333}.summary-section{background:#fff;border:1px solid #ccc;box-shadow:none}.calendar-table th,.calendar-table td{border-color:#333;color:#333}.calendar-table th{background:#eee}.calendar-table .course-cell{background:#f9f9f9;border-left-color:#333}.calendar-table .course-cell .course-time,.calendar-table .cell-buttons{display:none}}
@media(max-width:600px){.form-row{grid-template-columns:1fr}body{padding:1rem}.calendar-table{font-size:0.75rem}.calendar-table th,.calendar-table td{padding:0.35rem 0.25rem;min-width:95px}.calendar-table td{height:200px}.calendar-table .course-cell{font-size:0.7rem;min-height:88px;height:88px}.calendar-table .course-cell .cell-buttons .done-btn,.calendar-table .course-cell .cell-buttons .remove-btn{font-size:0.6rem;padding:0.15rem 0.25rem}.sidebar-magic{width:180px;font-size:0.8rem}.main-with-sidebar{margin-left:180px}}
    </style>
</head>
<body>
    <aside id="sidebarMagic" class="sidebar-magic" aria-label="‡∏°‡∏µ‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©">
        <h3>‚ú® ‡∏°‡∏µ‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß</h3>
        <div id="completedMagicList"></div>
    </aside>
    <div class="main-with-sidebar">
    <div class="container">
        <header>
            <h1>üìö ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            <p class="subtitle">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå</p>
        </header>

        <section class="registration-section">
            <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="course">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</label>
                    <select id="course" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏°‡πâ‡∏Å‡∏ß‡∏≤‡∏î">‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏°‡πâ‡∏Å‡∏ß‡∏≤‡∏î</option>
                        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏≤">‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏≤</option>
                        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏¢">‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏¢</option>
                        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≤">‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≤</option>
                        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£">‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£</option>
                        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ">‡∏ß‡∏¥‡∏ä‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</option>
                        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ß‡∏¥‡πÄ‡∏®‡∏©">‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ß‡∏¥‡πÄ‡∏®‡∏©</option>
                        <option value="‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                    </select>
                </div>
                <div class="form-group" id="specialMagicGroup" style="display:none">
                    <label for="specialMagicName">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <select id="specialMagicName">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© --</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="dateMonth">‡∏ß‡∏±‡∏ô-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <div class="date-input-group">
                            <select id="dateDay" required><option value="">‡∏ß‡∏±‡∏ô</option></select>
                            <select id="dateMonth" required>
                                <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="1">‡∏°.‡∏Ñ.</option><option value="2">‡∏Å.‡∏û.</option><option value="3">‡∏°‡∏µ.‡∏Ñ.</option><option value="4">‡πÄ‡∏°.‡∏¢.</option>
                                <option value="5">‡∏û.‡∏Ñ.</option><option value="6">‡∏°‡∏¥.‡∏¢.</option><option value="7">‡∏Å.‡∏Ñ.</option><option value="8">‡∏™.‡∏Ñ.</option>
                                <option value="9">‡∏Å.‡∏¢.</option><option value="10">‡∏ï.‡∏Ñ.</option><option value="11">‡∏û.‡∏¢.</option><option value="12">‡∏ò.‡∏Ñ.</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="time">‡πÄ‡∏ß‡∏•‡∏≤ (24 ‡∏ä‡∏°.)</label>
                        <div class="time-input-group">
                            <select id="timeHour" required><option value="">--</option></select>
                            <span class="time-separator">:</span>
                            <select id="timeMinute" required><option value="">--</option></select>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-primary" aria-label="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
            </form>
        </section>

        <section class="summary-section">
            <h2>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            <div id="statsBar" class="stats-bar"><button type="button" class="btn-clear-cal" id="btnClearCalendar">‡∏•‡πâ‡∏≤‡∏á</button></div>
            <div class="calendar-wrapper">
                <p class="empty-message" id="emptyRegistered">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                <table id="calendarTable" class="calendar-table">
                    <thead><tr id="calendarHeader"></tr></thead>
                    <tbody id="calendarBody"></tbody>
                </table>
            </div>
        </section>

        <section class="remaining-section">
            <h2>‚è≥ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <p class="remaining-hint">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°</p>
            <div id="remainingList" class="remaining-list"></div>
        </section>
    </div>
    </div>
    <div id="toastContainer" class="toast-container"></div>

    <script>
const ALL_COURSES=['‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå','‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏°‡πâ‡∏Å‡∏ß‡∏≤‡∏î','‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏≤','‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏¢','‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≤','‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£','‡∏ß‡∏¥‡∏ä‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ','‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ß‡∏¥‡πÄ‡∏®‡∏©'];
const STORAGE_KEY='courseRegistrations';
const COMPLETED_MAGICS_KEY='completedSpecialMagics';
const SPECIAL_MAGICS_BY_YEAR={'‡∏õ‡∏µ1':['Revelio','Lumos','Incedio','Protego','Aquamenti'],'‡∏õ‡∏µ2':[],'‡∏õ‡∏µ3':[],'‡∏õ‡∏µ4':[],'‡∏õ‡∏µ5':[]};
const SPECIAL_MAGICS=[].concat(...Object.values(SPECIAL_MAGICS_BY_YEAR).filter(a=>a.length));
const THAI_DAYS=['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'];
const THAI_MONTHS=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];

function loadRegistrations(){
    try{
        const d=localStorage.getItem(STORAGE_KEY);
        if(!d)return [];
        const parsed=JSON.parse(d);
        if(!Array.isArray(parsed))return [];
        return parsed.filter(r=>r&&typeof r==='object'&&typeof r.course==='string'&&r.course.trim()!=='');
    }catch(_){return []}
}
function saveRegistrations(r){localStorage.setItem(STORAGE_KEY,JSON.stringify(r))}
function loadCompletedMagics(){
    try{const d=localStorage.getItem(COMPLETED_MAGICS_KEY);if(!d)return [];const p=JSON.parse(d);return Array.isArray(p)?p.filter(m=>typeof m==='string'&&m.trim()):[]}
    catch(_){return []}
}
function saveCompletedMagics(arr){localStorage.setItem(COMPLETED_MAGICS_KEY,JSON.stringify(arr))}
function extractMagicName(course){if(!course||typeof course!=='string')return'';const m=course.match(/‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©:\s*(.+)/);return m?m[1].trim():''}

function formatTime24(t){if(!t)return'';const p=t.split(':');return String(parseInt(p[0],10)).padStart(2,'0')+':'+String(parseInt(p[1]||0,10)).padStart(2,'0')}

function formatDateThai(s){if(!s||typeof s!=='string')return s||'';const d=new Date(s+'T12:00:00');if(isNaN(d.getTime()))return s;return THAI_DAYS[d.getDay()]+' '+d.getDate()+' '+THAI_MONTHS[d.getMonth()]}

function getDaysInMonth(month,year){
    const m=parseInt(month,10),y=year||new Date().getFullYear();
    if(isNaN(m)||m<1||m>12)return 31;
    const lastDay=new Date(y,m,0);
    return lastDay.getDate();
}
function buildDateFromDayMonth(day,month){
    const n=new Date(),y=n.getFullYear(),m=parseInt(month,10),d=parseInt(day,10);
    if(isNaN(m)||isNaN(d)||m<1||m>12||d<1)return null;
    const maxDays=getDaysInMonth(m,y);
    if(d>maxDays)return null;
    return y+'-'+String(m).padStart(2,'0')+'-'+String(d).padStart(2,'0');
}

function getTodayStr(){const n=new Date();return n.getFullYear()+'-'+String(n.getMonth()+1).padStart(2,'0')+'-'+String(n.getDate()).padStart(2,'0')}
function renderStats(){const regs=loadRegistrations(),completed=regs.filter(r=>r.status==='completed').length;const bar=document.getElementById('statsBar');if(!bar)return;const span=bar.querySelector('span');if(span)span.outerHTML='<span>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß <span class="stat-completed">'+completed+'</span> / '+ALL_COURSES.length+' ‡∏ß‡∏¥‡∏ä‡∏≤</span>';else bar.insertAdjacentHTML('afterbegin','<span>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß <span class="stat-completed">'+completed+'</span> / '+ALL_COURSES.length+' ‡∏ß‡∏¥‡∏ä‡∏≤</span>')}
function clearCalendar(){if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?'))return;saveRegistrations([]);updateCourseSelect();renderRegisteredList();renderRemainingList();renderStats();setDefaultFormValues();showToast('‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß','info')}
function showToast(msg,type){
    const c=document.getElementById('toastContainer');if(!c)return;
    const t=document.createElement('div');t.className='toast '+(type||'info');t.textContent=msg;
    c.appendChild(t);
    setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(-10px)';setTimeout(()=>t.remove(),300)},2500);
}

function renderRegisteredList(){
    let regs=loadRegistrations();
    const validDateStr=d=>d&&typeof d==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(d);
    let needsSave=false;
    regs=regs.map(reg=>{
        if(!reg.status){reg.status=reg.completed?'completed':'pending';needsSave=true}
        if(reg.isSpecial===undefined&&reg.course&&(reg.course.startsWith('‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©:')||reg.course.startsWith('‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©:'))){reg.isSpecial=true;needsSave=true}
        if(reg.course&&reg.course.startsWith('‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©:')){reg.course=reg.course.replace('‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©:','‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©:');needsSave=true}
        if(reg.course==='‡∏ß‡∏¥‡∏ä‡∏≤‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ'){reg.course='‡∏ß‡∏¥‡∏ä‡∏≤‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ';needsSave=true}
        if(!validDateStr(reg.date)){needsSave=true;
            if(reg.day){const dm={'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå':1,'‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£':2,'‡∏û‡∏∏‡∏ò':3,'‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ':4,'‡∏®‡∏∏‡∏Å‡∏£‡πå':5,'‡πÄ‡∏™‡∏≤‡∏£‡πå':6};const t=new Date(),td=dm[reg.day]||1;let diff=td-t.getDay();if(diff<=0)diff+=7;const d=new Date(t);d.setDate(t.getDate()+diff);return{...reg,date:d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}}
            const t=new Date();return{...reg,date:t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0')+'-'+String(t.getDate()).padStart(2,'0')}}
        return reg;
    });
    if(needsSave)saveRegistrations(regs);

    const wrapper=document.querySelector('.calendar-wrapper'),emptyMsg=document.getElementById('emptyRegistered'),thead=document.getElementById('calendarHeader'),tbody=document.getElementById('calendarBody');
    if(regs.length===0){wrapper.classList.remove('has-data');emptyMsg.style.display='block';return}

    wrapper.classList.add('has-data');
    const validDate=d=>d&&typeof d==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(d);
    const uniqueDates=[...new Set(regs.map(r=>r.date).filter(validDate))].sort();
    if(uniqueDates.length===0){wrapper.classList.remove('has-data');emptyMsg.style.display='block';return}

    emptyMsg.style.display='none';
    const byDate={};uniqueDates.forEach(d=>byDate[d]=[]);
    regs.forEach((reg,i)=>{if(validDate(reg.date)&&reg.time&&byDate[reg.date])byDate[reg.date].push({course:reg.course,time:formatTime24(reg.time),index:i,status:reg.status||'pending',isSpecial:!!reg.isSpecial})});
    uniqueDates.forEach(d=>byDate[d].sort((a,b)=>a.time.localeCompare(b.time)));

    const todayStr=getTodayStr();
    thead.innerHTML='';
    uniqueDates.forEach(d=>{const th=document.createElement('th');th.textContent=formatDateThai(d);if(d===todayStr)th.classList.add('today');thead.appendChild(th)});
    tbody.innerHTML='';
    const tr=document.createElement('tr');
    uniqueDates.forEach(date=>{
        const td=document.createElement('td');const items=byDate[date]||[];
        if(items.length>0){items.forEach(({course,time,index,status,isSpecial})=>{
            const st=status||'pending';
            const c=document.createElement('div');c.className='course-cell'+(isSpecial?' special':st==='preparing'?' preparing':st==='completed'?' completed':'');
            const displayName=isSpecial?extractMagicName(course)||course:course.replace(/^‡∏ß‡∏¥‡∏ä‡∏≤\s*/,'');
            const nameSpan=document.createElement('span');nameSpan.className='course-name';nameSpan.textContent=displayName;nameSpan.title=course;
            const timeSpan=document.createElement('span');timeSpan.className='course-time';timeSpan.textContent=time;
            const btnWrap=document.createElement('div');btnWrap.className='cell-buttons';
            const removeBtn=document.createElement('button');removeBtn.type='button';removeBtn.className='remove-btn';removeBtn.setAttribute('data-index',String(index));removeBtn.setAttribute('aria-label','‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ '+course);removeBtn.textContent='√ó';
            removeBtn.onclick=e=>{e.stopPropagation();removeRegistration(parseInt(removeBtn.dataset.index))};
            if(!isSpecial){const statusLabels={pending:'‡∏£‡∏≠‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',preparing:'‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',completed:'‚úì'};const doneBtn=document.createElement('button');doneBtn.type='button';doneBtn.className='done-btn';doneBtn.setAttribute('data-index',String(index));doneBtn.setAttribute('aria-label','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '+course);doneBtn.textContent=statusLabels[st]||statusLabels.pending;doneBtn.title=st==='pending'?'‡∏£‡∏≠‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô':st==='preparing'?'‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô':'‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß';doneBtn.onclick=e=>{e.stopPropagation();cycleStatus(parseInt(doneBtn.dataset.index))};btnWrap.appendChild(doneBtn)}
            btnWrap.appendChild(removeBtn);c.appendChild(nameSpan);c.appendChild(timeSpan);c.appendChild(btnWrap);td.appendChild(c);
        })}
        else{td.classList.add('empty-cell');td.textContent='‚Äî'}
        tr.appendChild(td);
    });
    tbody.appendChild(tr);
}

function updateCourseSelect(){
    const regs=loadRegistrations(),registered=regs.map(r=>r.course),remaining=ALL_COURSES.filter(c=>!registered.includes(c));
    const select=document.getElementById('course'),fg=select?.closest('.form-group');
    if(!select)return;
    select.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>'+remaining.map(c=>'<option value="'+c+'">'+c+'</option>').join('')+'<option value="‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>';
    select.value=remaining.includes(select.value)?select.value:(select.value==='‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©'?'‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©':'');
    let msg=fg?.querySelector('.all-registered-msg');
    if(remaining.length===0){if(!msg){msg=document.createElement('p');msg.className='all-registered-msg';msg.textContent='‚úì ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡πâ‡∏ß';fg?.appendChild(msg)}select.required=false}
    else{msg?.remove();select.required=true}
}

function renderRemainingList(){
    const regs=loadRegistrations(),registered=regs.map(r=>r.course),c=document.getElementById('remainingList');
    c.innerHTML='';
    ALL_COURSES.forEach(course=>{
        const i=document.createElement('div');i.className='remaining-item'+(registered.includes(course)?' registered':'');
        i.textContent=course;
        if(!registered.includes(course)){i.setAttribute('role','button');i.setAttribute('tabindex','0');i.setAttribute('aria-label','‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ '+course);const pickCourse=()=>{const sel=document.getElementById('course');if(sel&&ALL_COURSES.includes(course)){sel.value=course;sel.focus();showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '+course+' ‡πÅ‡∏•‡πâ‡∏ß','info')}};i.onclick=pickCourse;i.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();pickCourse()}}}
        c.appendChild(i);
    });
}

function addRegistration(course,date,time){
    const regs=loadRegistrations();
    let finalCourse=course;
    let isSpecial=false;
    if(course==='‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©'){
        const customName=document.getElementById('specialMagicName')?.value?.trim();
        if(!customName){showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô','error');return}
        finalCourse='‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©: '+customName;
        isSpecial=true;
    }
    if(regs.some(r=>r.course===finalCourse)){showToast('‡∏ß‡∏¥‡∏ä‡∏≤ '+finalCourse+' ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏∑‡πà‡∏ô','error');return}
    regs.push({course:finalCourse,date,time,status:'pending',isSpecial});saveRegistrations(regs);
    updateCourseSelect();renderRegisteredList();renderRemainingList();renderStats();
    showToast('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô '+course+' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
    const summary=document.querySelector('.summary-section');
    if(summary)summary.scrollIntoView({behavior:window.matchMedia('(prefers-reduced-motion:reduce)').matches?'auto':'smooth',block:'start'});
}

function cycleStatus(index){
    const regs=loadRegistrations();
    const reg=regs[index];
    if(!reg)return;
    const next={pending:'preparing',preparing:'completed',completed:'pending'};
    reg.status=next[reg.status||'pending']||'pending';
    saveRegistrations(regs);
    renderRegisteredList();renderStats();
    const msgs={pending:'‡∏£‡∏≠‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',preparing:'‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô '+reg.course,completed:'‚úì '+reg.course+' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'};
    showToast(msgs[reg.status]||'','info');
}
function isMagicLearned(name){const completed=loadCompletedMagics();return completed.some(c=>c.toLowerCase()===String(name).toLowerCase())}
function toggleMagicLearned(name){
    const arr=loadCompletedMagics();const idx=arr.findIndex(c=>c.toLowerCase()===String(name).toLowerCase());
    const canonical=SPECIAL_MAGICS.find(m=>m.toLowerCase()===name.toLowerCase())||name;
    if(idx>=0){arr.splice(idx,1)}else{arr.push(canonical)}
    saveCompletedMagics(arr);renderCompletedMagics();initSpecialMagicSelect();showToast(idx>=0?'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å '+canonical:'‡∏°‡∏µ‡πÄ‡∏ß‡∏ó‡∏¢‡πå '+canonical+' ‡πÅ‡∏•‡πâ‡∏ß','info')
}
function renderCompletedMagics(){
    const list=document.getElementById('completedMagicList');if(!list)return;
    list.innerHTML='';
    Object.entries(SPECIAL_MAGICS_BY_YEAR).forEach(([year,magics])=>{
        const div=document.createElement('div');div.className='sidebar-magic-year';
        const h4=document.createElement('h4');h4.textContent=year;div.appendChild(h4);
        const ul=document.createElement('ul');ul.className='sidebar-magic-list';
        const learned=magics.filter(m=>isMagicLearned(m)),notLearned=magics.filter(m=>!isMagicLearned(m));
        [...learned,...notLearned].forEach(m=>{
            const li=document.createElement('li');li.textContent=m;li.className=isMagicLearned(m)?'learned':'not-learned';
            li.setAttribute('role','button');li.setAttribute('tabindex','0');li.setAttribute('aria-label','‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '+m);
            li.onclick=()=>toggleMagicLearned(m);li.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleMagicLearned(m)}};
            ul.appendChild(li);
        });
        div.appendChild(ul);list.appendChild(div);
    });
}
function removeRegistration(index){
    const regs=loadRegistrations();
    const reg=regs[index];
    if(!reg)return;
    if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ "'+reg.course+'" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?'))return;
    regs.splice(index,1);saveRegistrations(regs);
    updateCourseSelect();renderRegisteredList();renderRemainingList();renderStats();
    showToast('‡∏•‡∏ö '+reg.course+' ‡πÅ‡∏•‡πâ‡∏ß','info');
}

function updateDateDayOptions(){
    const daySelect=document.getElementById('dateDay'),monthSelect=document.getElementById('dateMonth');
    if(!daySelect||!monthSelect)return;
    const month=monthSelect.value,year=new Date().getFullYear(),currentDay=daySelect.value;
    const maxDays=month?getDaysInMonth(month,year):31;
    daySelect.innerHTML='';
    const opt0=document.createElement('option');opt0.value='';opt0.textContent='‡∏ß‡∏±‡∏ô';daySelect.appendChild(opt0);
    for(let d=1;d<=maxDays;d++){const o=document.createElement('option');o.value=String(d);o.textContent=String(d);daySelect.appendChild(o)}
    if(currentDay&&parseInt(currentDay,10)<=maxDays)daySelect.value=currentDay;
    else if(parseInt(currentDay,10)>maxDays)daySelect.value=String(maxDays);
}
function initDateDaySelect(){
    updateDateDayOptions();
    document.getElementById('dateMonth')?.addEventListener('change',updateDateDayOptions);
}
function setDefaultFormValues(){
    const n=new Date();
    const daySelect=document.getElementById('dateDay'),monthSelect=document.getElementById('dateMonth');
    const hourSelect=document.getElementById('timeHour'),minuteSelect=document.getElementById('timeMinute');
    if(monthSelect){monthSelect.value=String(n.getMonth()+1)}
    updateDateDayOptions();
    if(daySelect){daySelect.value=String(n.getDate())}
    if(hourSelect){hourSelect.value='09'}
    if(minuteSelect){minuteSelect.value='00'}
}

function initTimeSelects(){
    const h=document.getElementById('timeHour'),m=document.getElementById('timeMinute');if(!h||!m)return;
    h.innerHTML='<option value="">--</option>';for(let i=0;i<24;i++){const o=document.createElement('option');o.value=String(i).padStart(2,'0');o.textContent=String(i).padStart(2,'0');h.appendChild(o)}
    m.innerHTML='<option value="">--</option>';for(let i=0;i<60;i+=5){const o=document.createElement('option');o.value=String(i).padStart(2,'0');o.textContent=String(i).padStart(2,'0');m.appendChild(o)}
}

document.getElementById('registrationForm').onsubmit=e=>{
    e.preventDefault();
    const course=document.getElementById('course').value,day=document.getElementById('dateDay').value,month=document.getElementById('dateMonth').value;
    const hour=document.getElementById('timeHour').value,minute=document.getElementById('timeMinute').value,time=hour&&minute?hour+':'+minute:'';
    const date=buildDateFromDayMonth(day,month);
    if(!course||!time){showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô','error');return}
    if(course==='‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©'&&!document.getElementById('specialMagicName')?.value?.trim()){showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô','error');return}
    if(!date){showToast('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å.‡∏û. ‡∏°‡∏µ‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà 28 ‡∏´‡∏£‡∏∑‡∏≠ 29 ‡∏ß‡∏±‡∏ô)','error');return}
    addRegistration(course,date,time);
    document.getElementById('course').value='';
    document.getElementById('specialMagicName').value='';
    document.getElementById('specialMagicGroup').style.display='none';
    setDefaultFormValues();
};

document.getElementById('btnClearCalendar')?.addEventListener('click',clearCalendar);
function initSpecialMagicSelect(){
    const sel=document.getElementById('specialMagicName');if(!sel)return;
    const currentVal=sel.value;
    sel.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© --</option>';
    SPECIAL_MAGICS.filter(m=>!isMagicLearned(m)).forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;sel.appendChild(o)});
    if(currentVal&&!isMagicLearned(currentVal))sel.value=currentVal;
}
document.getElementById('course').addEventListener('change',function(){
    const g=document.getElementById('specialMagicGroup');
    if(g){g.style.display=this.value==='‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©'?'block':'none';if(this.value==='‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©')initSpecialMagicSelect()}
});
initDateDaySelect();initTimeSelects();initSpecialMagicSelect();setDefaultFormValues();updateCourseSelect();renderRegisteredList();renderRemainingList();renderStats();renderCompletedMagics();
    </script>
</body>
</html>
